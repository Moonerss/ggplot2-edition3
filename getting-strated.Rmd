```{r, include = FALSE}
source("common.R")
columns(1, 2 / 3)
```

# 第一步 {#getting-started}  

## 简介  

本章的目的是教您如何尽快使用`ggplot2`生成有用的图形。您将学习`ggplot()`的基础知识以及一些有用的“食谱”，以制作出最重要的图表。`ggplot()`允许您仅用几行代码即可完成复杂的绘图，因为它基于丰富的基础理论（即图形语法）。在这里，我们将跳过基础理论，而将重点放在练习上，在以后的章节中，您将学习如何使用语法的全部表达。  

在这一章中，你将学习到：  

- 在第 \@ref(fuel-economy-data) 节中认识ggplot2包中包含的`mpg`数据集。  

- 在第 \@ref(basic-use) 节中学习三个绘图的关键组成部分：数据(data)、美学(aesthetics)以及几何图层(geoms)。  

- 在第 \@ref(aesthetics) 节中学习如何通过美学(aesthetics)将更多变量添加到图形中。  

- 在第 \@ref(qplot-faceting) 节中学习如何使用分面(faceting)操作额外的分层变量。  

- 在第 \@ref(plot-geoms) 节中学习如何使用不同的图层创建不同类型的图片。  

- 在第 \@ref(axes) 节中学习如何修改坐标轴。  

- 在第 \@ref(output) 节中学习除了构建图像之外的其他执行操作，例如将其保存到磁盘。  


## 燃油经济性数据 {#fuel-economy-data}  

在这一章节中，我们最常用到ggplot2内置的一套数据集:`mpg`。它包含美国环境保护署（http://fueleconomy.gov）收集的有关1999年和2008年流行车型的燃油经济性的信息。您可以通过加载ggplot2来访问数据：  

```{r}
library(ggplot2)
mpg
```

变量的意思非常简单：  

- `cty`和`hwy`记录了在城市和高速公路行驶的每加仑(mpg)可行使英里数。  

- `displ`是发动机排量，以升为单位。  

- `drv`是动力传动系统：前轮（f），后轮（r）或四轮（4）。  

- `model`是汽车的模型。 之所以有38种型号，是因为它们在1999年至2008年之间每年都有新版本。  

- `class`是描述汽车类型的分类变量：两个座位，SUV，紧凑型车等。  

该数据集可以提出许多有趣的问题。发动机尺寸和燃油经济性如何相关？某些制造商是否比其他制造商更在意燃油经济性？在过去的十年中，燃油经济性有所改善吗？我们将尝试回答其中一些问题，并在此过程中学习如何使用ggplot2创建一些基本图形。  

### 练习  

1. 列出五个可以从`mpg`数据集获取更多信息的函数。  

2. 您如何找出ggplot2还包含哪些其他数据集？  

3. 除美国外，大多数国家/地区使用的是油耗（固定距离内消耗的燃油），而不是燃油经济性（固定量的燃油所行驶的距离）。您如何将`cty`和`hwy`转换为l/100km的欧洲标准？  

4. 哪个制造商在该数据集中拥有最多的模型？哪个型号变化最大？如果从型号名称中删除了传动系统的冗余规格（例如：“pathfinder 4wd”，“a4 quattro”），答案会有所变化吗？  

## 关键组件 {#basic-use}  

每个ggplot2图形都有三个关键组件：  

1. 数据(__data__)  

2. 变量和视觉属性之间的美学映射(__aesthetic mappings__)  

3. 至少一个描述如何呈现每个观察值的图层。 通常使用`geom`函数创建图层。  

下面是一个小例子：  

```{r qscatter}
ggplot(mpg, aes(x = displ, y = hwy)) + 
  geom_point()
```

这些代码产生一张散点图，对应的信息为：  

1. data-->mpg  
2. 美学映射-->发动机尺寸映射到x轴，燃油经济性映射到y轴  
3. 图层设置-->points  

请注意调用此函数的结构：`ggplot()`中提供了数据和美学映射，然后使用`+`添加图层。这是一种重要的模式，随着您对ggplot2的更多了解，您将通过添加更多类型的组件来构建越来越复杂的图。  

几乎每个图都需要将变量映射到x和y轴，因此命名这些内容是很无聊的，因此aes（）的前两个未命名的参数将映射到x和y。 这意味着以下代码与上面的示例相同：

```{r, eval = FALSE}
ggplot(mpg, aes(displ, hwy)) +
  geom_point()
```

在整本书中，我都会坚持使用这种风格书写，所以请不要忘记 `aes()` 的前两个参数是 `x` 和 `y`。请注意，我将每个单独的命令都放在一行。我建议您在自己的代码中也这样操作，可以轻松查看图片和代码内部的详细情况。在本章节中，有时在绘图时只用一行代码，因为这样可以比较轻松的观察绘图变量之间的差异。  

从上面的图中可以观察到很强的相关性：随着发动机尺寸的增大，燃油经济性也越来越差。还有一些有趣的离群值：一些具有大型发动机的汽车获得的燃油经济性高于平均水平。您认为它们是哪种汽车？  

### 练习  

1. 您如何描述 `cty` 和 `hwy` 之间的关系？ 您是否对从该图得出结论有任何担忧？  

2. `ggplot(mpg, aes(model, manufacturer)) + geom_point()`构造出什么图像？它是否有用？你怎样修改数据才能使它富有更多的信息？  

3. 描述以下每个图所使用的数据，美学映射和图层。您需要稍作猜测，因为您尚未看到所有数据集和函数，但请使用常识！ 在运行代码之前，请查看是否可以预测绘图的外观。  

   1. `ggplot(mpg, aes(cty, hwy)) + geom_point()`
   2. `ggplot(diamonds, aes(carat, price)) + geom_point()`
   3. `ggplot(economics, aes(date, unemploy)) + geom_line()`
   4. `ggplot(mpg, aes(cty)) + geom_histogram()`
   
## 颜色、大小、形状以及其他美学属性  

要向绘图中添加其他变量，我们可以使用其他美学元素，例如颜色，形状和大小（注意：虽然我在本书中使用的都是英式拼写，但ggplot2也接受美式拼写）。 这些以与 `x` 和 `y` 美学相同的方式工作，并被添加到对 `aes()` 的调用中：  

* `aes(displ, hwy, colour = class)`
* `aes(displ, hwy, shape = drv)`
* `aes(displ, hwy, size = cyl)`  

ggplot2负责将具体的数据（例如：f，r，4）根据比例尺转换为美学属性（例如：“red”，“yellow”，“green”）。每一张图都有美学属性对应的比例尺。比例尺还负责创建参考线，轴或图例，使您可以读取图，将美观值转换回数据值。目前，我们将使用ggplot2提供的默认比例尺。你将会在第\@ref(scale-colour)章学习如何覆盖它们。  

要了解有关上一个散点图中的那些偏远变量的更多信息，我们可以将类变量映射到颜色上：  

```{r qplot-aesthetics}
ggplot(mpg, aes(displ, hwy, colour = class)) + 
  geom_point()
```

函数为每个点提供了与其类别相对应的颜色。图例使我们能够从颜色中读取数据值，从而是我们可以了解到，因发动机尺寸不同而具有高燃油经济性的汽车有两个特点：具有大发动机但车身轻巧的汽车。  

如果您想将美学设置为固定值而不进行缩放，请在 `aes()` 外部的各个图层中进行设置。 比较以下两个图：  

`r columns(2, 2/3)`
```{r}
ggplot(mpg, aes(displ, hwy)) + geom_point(aes(colour = "blue"))
ggplot(mpg, aes(displ, hwy)) + geom_point(colour = "blue")
```

在第一个图中，"blue" 这个值被缩放为粉红色，并添加了图例。在第二个图中，这些点被赋予颜色为蓝色。您将在第\@ref(setting-mapping)章中对这项技术进行详细的了解。有关颜色和其他美学属性所需的值，请参考`vignette("ggplot2-specs")`。  

不同类型的美学属性与不同类型的变量配合使用效果更好。例如，颜色和形状可以很好地用于分类变量，而大小可以很好地用于连续变量。对于不同数据量的数据处理也有所不同：如果数据量很大，则很难区分不同的组别，一种替代解决方案是使用后边所说的分面进行操作。  

在绘图中使用美学属性时，通常简单的能带来更多的信息。我们很难同时看到颜色，形状和大小之间的相互关系，因此在使用美学属性时要克制自己。与其尝试制作一个可以同时显示所有内容的非常复杂的图片，不如看看是否可以创建一组讲述一个故事的简单图片，从而使读者逐渐理解数据。  

### 练习  

1. 尝试使用颜色，形状和尺寸等美学属性。 将它们映射到连续值时会发生什么？映射到分类变量呢？当您在一个图形中使用多个美学时会发生什么？  

2. 如果将连续变量映射到形状会怎样？ 为什么？ 如果将 `trans` 映射到形状会怎样？ 为什么？  

3. 动力传动系统与燃油经济性有何关系？ 传动系统与发动机尺寸和等级有何关系？  

## 分面 {#qplot-faceting}  


